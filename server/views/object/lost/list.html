<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>ë¶„ì‹¤ë¬¼ ë¶„ì‹¤ ê²Œì‹œê¸€ ëª©ë¡</title>
    <style>
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .write-button {
            padding: 6px 12px;
            font-size: 14px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            text-decoration: none;
        }

        .write-button:hover {
            background-color: #45a049;
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <h1>ë¶„ì‹¤ë¬¼ ë¶„ì‹¤ ê²Œì‹œê¸€ ëª©ë¡</h1>
        <a class="write-button" href="/object/lost/write">ê¸€ ì‘ì„±í•˜ê¸°</a>
    </div>

    <!-- ğŸ” ê²€ìƒ‰ í¼ ì¶”ê°€ -->
    <form id="search-form" style="margin: 20px 0;">
        <label>í†µí•© ê²€ìƒ‰ì–´: <input type="text" name="search" placeholder="ë¬¼í’ˆëª…, ì¥ì†Œ, ì œëª© ë“±"></label><br><br>

        <label>ê²Œì‹œ ë‚ ì§œ: </label>
        <input type="date" name="dateStart"> ~
        <input type="date" name="dateEnd"><br><br>

        <label>ë¶„ì‹¤ ì¼ì: </label>
        <input type="date" name="lstYmdStart"> ~
        <input type="date" name="lstYmdEnd"><br><br>

        <label>ì‹œ/ë„: <input type="text" name="si" placeholder="ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ"></label><br>
        <label>ì‹œêµ°êµ¬: <input type="text" name="sgg" placeholder="ì˜ˆ: ê°•ë‚¨êµ¬"></label><br>
        <label>ìë©´ë™: <input type="text" name="emd" placeholder="ì˜ˆ: ì—­ì‚¼ë™"></label><br><br>

        <button type="submit">ê²€ìƒ‰</button>
    </form>


    <ul id="post-list">
        <li>ë¡œë”© ì¤‘...</li>
    </ul>

    <div id="pagination" style="margin-top: 20px;"></div>

    <script>
        function getQueryFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const query = {};
            for (const [key, value] of urlParams.entries()) {
                if (value.trim()) query[key] = value.trim();
            }
            return query;
        }

        function getPageFromURL() {
            const query = getQueryFromURL();
            return parseInt(query.page) || 1;
        }

        function searchPosts(pageNum, query) {
            const queryString = new URLSearchParams({ ...query, page: pageNum }).toString();
            fetch(`/api/object/lost/search?${queryString}`)
                .then(res => res.json())
                .then(data => {
                    renderPosts(data.results, pageNum, query);
                    createPagination(data.totalPages, pageNum, query);
                })
                .catch(() => {
                    document.getElementById('post-list').innerHTML = '<li>ì˜¤ë¥˜ ë°œìƒ</li>';
                });
        }

        function renderPosts(posts, currentPage, currentQuery) {
            const ul = document.getElementById('post-list');
            ul.innerHTML = '';
            posts.forEach(post => {
                const li = document.createElement('li');
                const queryString = new URLSearchParams({ ...currentQuery, page: currentPage }).toString();
                li.innerHTML = `
                <h3><a href="/object/lost/detail/${post._id}?${queryString}">
                    ${post.lstPrdtNm || 'ë¬¼í’ˆëª… ì—†ìŒ'}
                </a></h3>
                <p><strong>ê²Œì‹œë‚ ì§œ:</strong> ${post.date || '-'}</p>
                <p><strong>ë¶„ì‹¤ì¥ì†Œ:</strong> ${post.lstPlace || '-'}</p>
                ${post.lstFilePathImg ? `<img src="${post.lstFilePathImg}" width="150">` : ''}
                <hr>
            `;
                ul.appendChild(li);
            });
        }

        function createPagination(totalPages, currentPage, query = {}) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                if (i === currentPage) {
                    btn.disabled = true;
                    btn.style.fontWeight = 'bold';
                }
                btn.onclick = () => {
                    const queryString = new URLSearchParams({ ...query, page: i }).toString();
                    window.history.pushState({}, '', `?${queryString}`);
                    searchPosts(i, query);
                };
                pagination.appendChild(btn);
            }
        }

        document.getElementById('search-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const query = {};
            for (const [key, value] of formData.entries()) {
                if (value.trim()) query[key] = value.trim();
            }
            const queryString = new URLSearchParams({ ...query, page: 1 }).toString();
            window.history.pushState({}, '', `?${queryString}`);
            searchPosts(1, query);
        });

        const query = getQueryFromURL();
        const page = getPageFromURL();
        searchPosts(page, query);
    </script>
</body>

</html>